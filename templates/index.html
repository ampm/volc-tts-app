<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>火山TTS合成（并发+进度）</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <main class="container">
    <h1>TXT → 火山TTS（并发+重试+进度）</h1>
    <form id="uploadForm">
      <input type="file" name="file" accept=".txt" required />
      <button type="submit">上传并开始</button>
    </form>

    <div id="status">尚未开始</div>
    <div class="bar"><div id="bar"></div></div>
    <a id="dl" href="#" download>下载合成音频</a>
  </main>

  <script>
    const form = document.getElementById('uploadForm');
    const statusEl = document.getElementById('status');
    const bar = document.getElementById('bar');
    const dl = document.getElementById('dl');


    async function poll(job_id) {
      let delay = 1000;          // 起始 1s
      const maxDelay = 5000;     // 上限 5s
      let timer = null;

      const step = async () => {
        try {
          const r = await fetch(`/status/${job_id}`);
          if (!r.ok) return;
          const s = await r.json();
          const total = s.total || 0, done = s.done || 0, failed = s.failed || 0;
          const pct = total > 0 ? Math.round((done + failed) / total * 100) : 0;

          statusEl.textContent = `状态：${s.state || 'N/A'}  |  ${s.message || ''}\n进度：${done}/${total}（失败 ${failed}）`;
          bar.style.width = pct + '%';

          // 有失败详情就展示一点（可选）
          if (Array.isArray(s.failures) && s.failures.length) {
            const lines = s.failures.slice(0, 3).map(f => `片段#${f.idx}: ${f.error}`);
            statusEl.textContent += "\n失败示例：\n" + lines.join("\n");
          }

          if (s.state === 'done') {
            dl.href = `/result/${job_id}`;
            dl.style.display = 'inline-block';
            dl.textContent = '下载合成音频';
            return; // 停止轮询
          }
          if (s.state === 'error') {
            statusEl.textContent += '\n任务失败';
            return; // 停止轮询
          }

          // 任务未结束：指数退避（最多 5s）
          delay = Math.min(delay * 1.5, maxDelay);
        } catch (e) {
          // 网络瞬断等，轻微退避
          delay = Math.min(delay * 1.5, maxDelay);
        } finally {
          timer = setTimeout(step, delay);
        }
      };

      // start
      step();
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      dl.style.display = 'none';
      dl.removeAttribute('href');
      bar.style.width = '0%';
      statusEl.textContent = '正在上传...';

      const fd = new FormData(form);
      try {
        const r = await fetch('/tts', { method: 'POST', body: fd });
        if (!r.ok) {
          const err = await r.json().catch(()=>({detail:'提交失败'}));
          throw new Error(err.detail || '提交失败');
        }
        const data = await r.json();
        statusEl.textContent = '任务已创建，开始处理...';
        poll(data.job_id);
      } catch (err) {
        statusEl.textContent = '出错：' + err.message;
      }
    });
  </script>
</body>
</html>
